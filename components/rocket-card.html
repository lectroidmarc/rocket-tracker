<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../bower_components/iron-icons/communication-icons.html">

<link rel="import" href="../components/geo-distance.html">
<link rel="import" href="../components/map-button.html">

<dom-module id="rocket-card">
  <template>
    <style>
      :host {
        transition: opacity 1s;
      }

      paper-card {
        background-color: var(--rocket-card-background-color, white);
        color: var(--primary-text-color);
        width: 100%;
        overflow: hidden;
      }

      paper-button {
        color: var(--primary-color);
      }
      paper-button iron-icon {
        vertical-align: -6px;
      }

      .distance {
        color: var(--light-text-color);
        font-size: 15px;
      }

      .header {
        @apply(--paper-font-headline);
        margin-bottom: 5px;
      }
      .header .rocketname {
        outline-color: var(--primary-color);
      }

      .status {
        background-color: var(--paper-green-600);
        border-radius: 2px;
        color: white;
        padding: 2px 6px;
      }
      .status::after {
        content: 'Active';
      }
      .status.inactive {
        background-color: var(--paper-red-600);
      }
      .status.inactive::after {
        content: 'Inactive';
      }

      .location {
        @apply(--paper-font-subhead);
        color: var(--light-text-color);
      }
      .location iron-icon {
        color: var(--primary-color);
        height: 18px;
        width: 18px;
        vertical-align: -3px;
      }

      .lastupdated {
        color: var(--light-text-color);
        font-size: 12px;
        font-style: italic;
      }

      .right {
        float: right;
      }
    </style>

    <paper-card>
      <div class="card-content">
        <geo-distance to-position="[[rocket.location]]" class="distance right">
          <iron-icon icon="communication:location-on"></iron-icon>
        </geo-distance>

        <div class="header">
          <span id="rocketname" class="rocketname" contenteditable>[[name]]</span>
        </div>

        <div id="status" class="status right inactive"></div>

        <div class="location">
          Location: <span id="latitude">---</span>, <span id="longitude">---</span>
          <iron-icon id="fix"></iron-icon>
          <iron-icon id="battery"></iron-icon>
        </div>

        <div class="lastupdated">
          Last Updated: <span id="prettydate"></span>
        </div>
      </div>

      <div class="card-actions">
        <map-button rocket="[[rocket]]" name="[[name]]"></map-button>
        <paper-button class="right" on-tap="hideCard">
          <iron-icon icon="icons:clear"></iron-icon>
          Hide
        </paper-button>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'rocket-card',

      properties: {
        rocket: {
          type: Object,
          observer: '_rocketChanged'
        },
        name: {
          type: String
        }
      },

      ready: function () {
        var self = this;
        var firebase = new Firebase('https://amber-torch-2600.firebaseio.com/metadata');

        firebase.child(this.rocket.__firebaseKey__).on('value', function(snapshot) {
          self.name = (snapshot.exists() && snapshot.val().name) ? snapshot.val().name : snapshot.key();
        });

        this.$.rocketname.addEventListener('input', function (e) {
          firebase.child(self.rocket.__firebaseKey__).update({
            name: self.$.rocketname.textContent
          });
        });

        var hidden = (localStorage.hidden) ? JSON.parse(localStorage.hidden) : {};
        if (hidden[this.rocket.__firebaseKey__]) {
          self.style.display = 'none';
        }
      },

      _rocketChanged: function (rocket) {
        var self = this;

        if (rocket.location) {
          this.$.latitude.textContent = rocket.location.latitude;
          this.$.longitude.textContent = rocket.location.longitude;
        }

        this.$.fix.icon = (rocket.fix) ? 'device:gps-fixed' : 'device:gps-not-fixed';
        this.$.fix.title = (rocket.fix) ? 'Has GPS Fix' : 'No fix';

        if (rocket.battery === 100) {
          this.$.battery.icon = 'device:battery-full';
          this.$.battery.title = 'Battery: 100%';
        } else if (rocket.battery === 0) {
          this.$.battery.icon = 'device:battery-alert';
          this.$.battery.title = 'Battery Low!';
        } else {
          this.$.battery.icon = 'device:battery-' + rocket.battery;
          this.$.battery.title = 'Battery: ' + rocket.battery + '%';
        }

        var date = new Date(rocket.time);
        this.$.prettydate.textContent = date.toLocaleString();

        if (rocket.time > Date.now() - 15000) {
          this.$.status.classList.remove('inactive');

          clearTimeout(this._timeout);
          this._timeout = setTimeout(function () {
            self.$.status.classList.add('inactive');
          }, 10000);
        }
      },

      hideCard: function () {
        var self = this;

        var hidden = (localStorage.hidden) ? JSON.parse(localStorage.hidden) : {};
        hidden[this.rocket.__firebaseKey__] = true;
        localStorage.hidden = JSON.stringify(hidden);

        this.style.opacity = 0;
        setTimeout(function () {
         self.style.display = 'none';
        }, 1000);

        this.fire('rockethide', {
          rocket: this.rocket.__firebaseKey__
        });
      },

      showCard: function () {
        var hidden = (localStorage.hidden) ? JSON.parse(localStorage.hidden) : {};
        delete hidden[this.rocket.__firebaseKey__];
        localStorage.hidden = JSON.stringify(hidden);

        this.style.opacity = 1;
        this.style.display = 'block';
      }
    });
  </script>
</dom-module>
