<dom-module id="geo-distance">
  <template>
    <content></content>
    <span id="distance">---</span>
  </template>

  <script>
    Polymer({
      is: 'geo-distance',

      properties: {
        toPosition: {
          type: Object,
          observer: '_toPositionChanged'
        }
      },

      ready: function () {
        var self = this;
        navigator.geolocation.watchPosition(function (position) {
          self.fromPosition = position.coords;
          self.updateDistance();
        });
      },

      _toPositionChanged: function () {
        this.updateDistance();
      },

      updateDistance: function () {
        if (this.fromPosition && this.toPosition) {
          var distance = this.haversine(this.fromPosition, this.toPosition);
          this.$.distance.textContent = Math.round(distance).toLocaleString('en-US') + 'ft';
        }
      },

      haversine: function (source, dest) {
        var R = 20903520; // Earth radius, feet

        var φ1 = source.latitude.toRadians();
        var φ2 = dest.latitude.toRadians();
        var Δφ = (dest.latitude - source.latitude).toRadians();
        var Δλ = (dest.longitude - source.longitude).toRadians();

        var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }
    });

    if (Number.prototype.toRadians === undefined) {
      Number.prototype.toRadians = function() { return this * Math.PI / 180; };
    }
  </script>
</dom-module>
